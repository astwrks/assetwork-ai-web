generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["darwin-arm64", "rhel-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model accounts {
  id                String  @id
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  users             users   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model api_keys {
  id           String      @id
  userId       String
  provider     ApiProvider
  keyName      String      @db.VarChar(100)
  encryptedKey String
  isActive     Boolean     @default(true)
  lastUsedAt   DateTime?
  usageCount   Int         @default(0)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime
  users        users       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider, keyName])
  @@index([isActive])
  @@index([userId, provider])
}

model messages {
  id        String      @id
  threadId  String
  userId    String
  role      MessageRole
  content   String
  reportId  String?
  metadata  Json?       @default("{}")
  createdAt DateTime    @default(now())
  updatedAt DateTime
  threads   threads     @relation(fields: [threadId], references: [id], onDelete: Cascade)
  users     users       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([reportId])
  @@index([threadId, createdAt])
  @@index([userId])
}

model playground_settings {
  id              String   @id
  userId          String   @unique
  defaultModel    String?  @db.VarChar(100)
  defaultProvider String?  @db.VarChar(50)
  autoSave        Boolean  @default(true)
  settings        Json     @default("{}")
  createdAt       DateTime @default(now())
  updatedAt       DateTime
  users           users    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model queries {
  id         String   @id
  userId     String
  query      String
  response   String
  provider   String?
  model      String?
  tokensUsed Int?
  cost       Float?
  metadata   Json?    @default("{}")
  createdAt  DateTime @default(now())
  users      users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt(sort: Desc)])
}

model report_sections {
  id          String      @id
  reportId    String
  type        SectionType
  title       String      @db.VarChar(300)
  htmlContent String
  order       Int
  version     Int         @default(1)
  editHistory Json[]      @default([])
  metadata    Json?       @default("{}")
  createdAt   DateTime    @default(now())
  updatedAt   DateTime
  reports     reports           @relation(fields: [reportId], references: [id], onDelete: Cascade)
  entity_mentions entity_mentions[]

  @@index([reportId, order])
}

model reports {
  id              String            @id
  userId          String
  threadId        String?
  title           String            @db.VarChar(300)
  description     String?
  htmlContent     String
  version         Int               @default(1)
  status          ReportStatus      @default(DRAFT)
  metadata        Json?             @default("{}")
  createdAt       DateTime          @default(now())
  updatedAt       DateTime
  report_sections report_sections[]
  entity_mentions entity_mentions[]
  users           users             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([threadId])
  @@index([userId, createdAt(sort: Desc)])
}

model sessions {
  id           String   @id
  sessionToken String   @unique
  userId       String
  expires      DateTime
  users        users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model templates {
  id              String       @id
  userId          String
  name            String       @db.VarChar(200)
  description     String?      @db.VarChar(1000)
  category        String?
  tags            String[]     @default([])
  structure       Json
  basePrompt      String?
  isPublic        Boolean      @default(false)
  usageCount      Int          @default(0)
  sourceThreadId  String?
  previewImageUrl String?
  isPremium       Boolean      @default(false)
  tier            TemplateTier @default(FREE)
  rating          Float        @default(0)
  ratingCount     Int          @default(0)
  icon            String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime
  users           users        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([isPremium, isPublic])
  @@index([isPublic, category])
  @@index([isPublic, tier, rating(sort: Desc)])
  @@index([isPublic, usageCount(sort: Desc)])
  @@index([tags])
  @@index([userId, createdAt(sort: Desc)])
}

model threads {
  id                  String       @id
  userId              String
  title               String       @db.VarChar(200)
  description         String?      @db.VarChar(1000)
  status              ThreadStatus @default(ACTIVE)
  currentReportId     String?
  reportVersions      String[]     @default([])
  sharedWith          Json[]       @default([])
  isTemplate          Boolean      @default(false)
  templateName        String?      @db.VarChar(200)
  templateDescription String?      @db.VarChar(1000)
  metadata            Json?        @default("{}")
  createdAt           DateTime     @default(now())
  updatedAt           DateTime
  messages            messages[]
  users               users        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([isTemplate])
  @@index([status])
  @@index([userId, isTemplate])
  @@index([userId, status, createdAt(sort: Desc)])
}

model users {
  id                   String               @id
  email                String               @unique
  password             String?
  name                 String?
  avatar               String?
  image                String?
  bio                  String?              @db.VarChar(500)
  aiCredits            Int                  @default(100)
  credits              Int                  @default(100)
  plan                 UserPlan             @default(FREE)
  googleId             String?              @unique
  isPublic             Boolean              @default(true)
  theme                Theme                @default(SYSTEM)
  notificationSettings Json                 @default("{\"push\": true, \"email\": true, \"updates\": true}")
  preferences          Json?                @default("{\"theme\": \"system\", \"language\": \"en\", \"timezone\": \"UTC\", \"notifications\": {\"push\": true, \"email\": true, \"marketing\": false}}")
  createdAt            DateTime             @default(now())
  updatedAt            DateTime
  emailVerified        DateTime?
  accounts             accounts[]
  api_keys             api_keys[]
  messages             messages[]
  playground_settings  playground_settings?
  queries              queries[]
  reports              reports[]
  sessions             sessions[]
  templates            templates[]
  threads              threads[]
  widgets              widgets[]
  users_A              users[]              @relation("UserFollows")
  users_B              users[]              @relation("UserFollows")

  @@index([createdAt])
  @@index([email])
  @@index([plan])
}

model verification_tokens {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model widgets {
  id        String   @id
  userId    String
  type      String   @db.VarChar(50)
  title     String   @db.VarChar(200)
  config    Json     @default("{}")
  position  Json     @default("{\"h\": 3, \"w\": 4, \"x\": 0, \"y\": 0}")
  isVisible Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime
  users     users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// ============================================
// Entity Intelligence System
// ============================================

model entities {
  id          String   @id @default(cuid())
  name        String   // "Airtel", "Apple Inc.", "Elon Musk"
  slug        String   @unique // "airtel", "apple-inc", "elon-musk"
  type        EntityType

  // Primary identifiers
  ticker      String?  // Stock ticker: "BHARTIARTL.NS"
  isin        String?  // International Securities ID
  cik         String?  // SEC CIK number
  lei         String?  // Legal Entity Identifier

  // Basic info
  description String?  @db.Text
  logo        String?  // Logo URL
  website     String?
  industry    String?
  sector      String?
  headquarters String?

  // Aggregated data (updated by AI)
  masterMarkdown String? @db.Text // The main entity.md content
  summary        String? @db.Text // AI-generated summary
  trendingTopics Json?   @default("[]") // Array of trending topics

  // Metadata
  mentionCount   Int      @default(0) // Total times mentioned across all reports
  lastMentioned  DateTime?
  firstMentioned DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  mentions entity_mentions[]
  insights entity_insights[]
  tags     entity_tags[]

  @@index([slug])
  @@index([type, mentionCount(sort: Desc)])
  @@index([ticker])
}

model entity_mentions {
  id       String   @id @default(cuid())
  entityId String
  reportId String

  // Context of mention
  context     String? @db.Text // Surrounding text where entity was mentioned
  sentiment   Float?  // -1.0 to 1.0 (negative to positive)
  relevance   Float?  // 0.0 to 1.0 (how relevant entity is to report)

  // Section where mentioned
  sectionId   String?
  sectionType SectionType?

  // Extracted metadata from mention
  metadata Json? @default("{}") // { "metric": "revenue", "value": "1.2B", etc. }

  createdAt DateTime @default(now())

  // Relations
  entity  entities       @relation(fields: [entityId], references: [id], onDelete: Cascade)
  report  reports        @relation(fields: [reportId], references: [id], onDelete: Cascade)
  section report_sections? @relation(fields: [sectionId], references: [id], onDelete: SetNull)

  @@unique([entityId, reportId])
  @@index([entityId, createdAt(sort: Desc)])
  @@index([reportId])
}

model entity_insights {
  id       String      @id @default(cuid())
  entityId String

  type    InsightType // TREND, COMPARISON, PREDICTION, SUMMARY, etc.
  title   String      @db.VarChar(300)
  content String      @db.Text

  // Source reports that contributed to this insight
  sourceReportIds String[] @default([])

  // Insight metadata
  confidence Float?  // 0.0 to 1.0
  timeframe  String? // "Q4 2024", "Last 30 days", etc.
  category   String? // "Financial", "Market", "Strategic", etc.

  // AI generation metadata
  model  String? @db.VarChar(100)
  prompt String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  entity entities @relation(fields: [entityId], references: [id], onDelete: Cascade)

  @@index([entityId, createdAt(sort: Desc)])
  @@index([type])
}

model entity_tags {
  id       String   @id @default(cuid())
  entityId String
  tag      String   // "telecom", "5G", "dividend-stock", etc.

  createdAt DateTime @default(now())

  entity entities @relation(fields: [entityId], references: [id], onDelete: Cascade)

  @@unique([entityId, tag])
  @@index([tag])
}

enum ApiProvider {
  OPENAI
  ANTHROPIC
  GOOGLE
  COINGECKO
  ALPHA_VANTAGE
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}

enum ReportStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum SectionType {
  METRIC
  CHART
  TABLE
  TEXT
  INSIGHT
  CUSTOM
  IMAGE
}

enum TemplateTier {
  FREE
  PRO
  ENTERPRISE
}

enum Theme {
  LIGHT
  DARK
  SYSTEM
}

enum ThreadStatus {
  ACTIVE
  ARCHIVED
}

enum UserPlan {
  FREE
  PRO
  ENTERPRISE
}

enum EntityType {
  COMPANY
  STOCK
  PERSON
  PRODUCT
  SECTOR
  CRYPTOCURRENCY
  COMMODITY
  INDEX
  ETF
  MUTUAL_FUND
  COUNTRY
  CURRENCY
}

enum InsightType {
  TREND          // Trending topic or pattern
  COMPARISON     // Comparison with peers
  PREDICTION     // Future prediction
  SUMMARY        // Overview summary
  RISK           // Risk analysis
  OPPORTUNITY    // Growth opportunity
  METRIC         // Key metric highlight
  NEWS           // Recent news summary
}
